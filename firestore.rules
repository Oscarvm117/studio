/**
 * @fileoverview Firestore Security Rules for Biotrazo Marketplace.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, ensuring that users can only access their own data.
 * All data is nested under /users/{userId}, reflecting the application's user-centric design.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Only the user can read/write their own profile.
 * - /users/{userId}/farmer_dashboard/{docId}: Stores farmer dashboard data. Only the farmer can read/write their own dashboard data.
 * - /users/{userId}/lots/{lotId}: Stores lot data for each farmer. Only the farmer can read/write their own lots.
 *
 * Key Security Decisions:
 * - User listing is implicitly disallowed.
 * - The rules prioritize simplicity and security by leveraging path-based ownership and avoiding complex queries or external data lookups.
 * - A collection group query on 'lots' is allowed for buyers to browse all available products.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isChangingOnlyStatusToSold() {
      let incomingData = request.resource.data;
      let existingData = resource.data;
      let statusChange = incomingData.status == 'sold' && existingData.status != 'sold';
      let otherFieldsUnchanged = incomingData.diff(existingData).affectedKeys().size() == 1 && incomingData.diff(existingData).affectedKeys().hasOnly(['status']);
      return statusChange && otherFieldsUnchanged;
    }

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isOwner(userId) && resource != null;

      /**
       * @description Secures farmer dashboard data, allowing only the farmer to manage their dashboard.
       * @path /users/{userId}/farmer_dashboard/{docId}
       */
      match /farmer_dashboard/{docId} {
        allow get: if isOwner(userId);
        allow list: if false;

        allow write: if isOwner(userId);
        allow delete: if isOwner(userId) && resource != null;
      }

      /**
       * @description Secures lot data for farmers. Farmers can manage their lots. Buyers can read them and mark them as sold.
       * @path /users/{userId}/lots/{lotId}
       */
      match /lots/{lotId} {
        allow get: if isSignedIn();
        allow list: if isOwner(userId);

        allow create: if isOwner(userId) && request.resource.data.farmerId == userId;
        allow delete: if isOwner(userId) && resource != null;
        
        allow update: if (isOwner(userId) && resource.data.farmerId == request.resource.data.farmerId) ||
                         (isSignedIn() && isChangingOnlyStatusToSold());
      }
    }
    
    /**
     * @description Collection group rule for querying across all 'lots' subcollections.
     * This allows buyers to view all available lots from any farmer in a single query.
     */
    match /{path=**}/lots/{lotId} {
        allow list: if isSignedIn();
    }
  }
}
