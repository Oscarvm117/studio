/**
 * @fileoverview Firestore Security Rules for Biotrazo Marketplace.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, ensuring that users can only access their own data.
 * All data is nested under /users/{userId}, reflecting the application's user-centric design.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Only the user can read/write their own profile.
 * - /users/{userId}/farmer_dashboard: Stores farmer dashboard data. Only the farmer can read/write their own dashboard data.
 * - /users/{userId}/lots/{lotId}: Stores lot data for each farmer. Only the farmer can read/write their own lots.
 *
 * Key Security Decisions:
 * - User listing is implicitly disallowed.
 * - The rules prioritize simplicity and security by leveraging path-based ownership and avoiding complex queries or external data lookups.
 * - A collection group query on 'lots' is allowed for buyers to browse all available products.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Secures user profiles, ensuring only the user can manage their own data.
     * @path /users/{userId}
     * @allow (create, update, delete, get) - User with ID 'user123' can create/update/delete/get their own profile when authenticated as 'user123'.
     * @deny (create, update, delete, get) - User with ID 'user456' cannot create/update/delete/get the profile of 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Do not allow listing all users

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isOwner(userId) && resource != null;

       /**
       * @description Secures farmer dashboard data, allowing only the farmer to manage their dashboard.
       * @path /users/{userId}/farmer_dashboard
       * @allow (create, update, delete, get) - User with ID 'farmer123' can create/update/delete/get their own dashboard when authenticated as 'farmer123'.
       * @deny (create, update, delete, get) - User with ID 'user456' cannot create/update/delete/get the dashboard of 'farmer123'.
       * @principle Restricts access to a user's own data tree.
       */
      match /farmer_dashboard/{docId} {
        allow get: if isOwner(userId);
        allow list: if false;

        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isOwner(userId) && resource.data.userId == request.resource.data.userId && resource != null;
        allow delete: if isOwner(userId) && resource != null;
      }

      /**
       * @description Secures lot data for farmers. Farmers can manage their lots. Buyers can read them.
       * @path /users/{userId}/lots/{lotId}
       * @allow (create, update, delete, get) - User with ID 'farmer123' can create/update/delete/get their own lot with ID 'lot456' when authenticated as 'farmer123'.
       * @deny (create, update, delete) - User with ID 'user456' (buyer) cannot create/update/delete the lot 'lot456' belonging to 'farmer123'.
       * @principle Enforces document ownership and validates relational integrity.
       */
      match /lots/{lotId} {
        // Anyone signed in can read a lot (buyers and farmers)
        allow get: if isSignedIn();
        // Farmers can list their own lots. Buyers use the collection group query below.
        allow list: if isOwner(userId);

        // Only the owner (farmer) can create, update, delete their lots
        allow create: if isOwner(userId) && request.resource.data.farmerId == userId;
        allow update: if isOwner(userId) && resource.data.farmerId == request.resource.data.farmerId && resource != null;
        allow delete: if isOwner(userId) && resource != null;
      }
    }
    
    /**
     * @description Collection group rule for querying across all 'lots' subcollections.
     * This allows buyers to view all available lots from any farmer in a single query.
     * @path /{path=**}/lots/{lotId}
     * @allow list - Any authenticated user (buyer or farmer) can perform a 'list' operation,
     * which is necessary for browsing the marketplace. The query in the app must include
     * `where('status', '==', 'available')` to be allowed.
     */
    match /{path=**}/lots/{lotId} {
        allow list: if isSignedIn();
    }
  }
}
